# times_esa バックエンド改善計画（段階的実装）

## 背景

[times_esa_mcp_serverで実装された検索機能の一般化](https://github.com/syou6162/times_esa_mcp_server/pull/26)をtimes_esaのバックエンド（Firebase Functions）にも適用したいが、現在テストコードが存在しないため、段階的に改善を進める。

## 現状の課題

1. **テストコードの不在**
   - Firebase Functionsにテストコードが一切存在しない
   - リファクタリング時に既存機能の動作保証ができない
   - CI/CDでの品質チェックができない

2. **検索機能の制限**
   - カテゴリの部分一致検索のみ
   - 日付範囲での絞り込み不可
   - ページネーション未対応

## テスト方針

現在のバックエンドはESA APIへのプロキシ的な役割が主なので、以下の現実的な方針を採用：

**テストすべき箇所**
1. リクエストパラメータの構築ロジック
2. 条件分岐によるフロー制御
3. 純粋な関数（`transformTitle`等）
4. 認証・認可のロジック

**テスト不要な箇所**
- ESA APIレスポンスの型検証
- 実際のAPI通信部分
- 単純なデータの受け渡し

## 実装ステップ

### ステップ1: 既存コードのテスト基盤構築

**目標**: 現在の機能を壊さずにテスト可能な状態にする

#### 1-1. テスト環境のセットアップ
- [ ] Vitestの導入（フロントエンドと統一）
- [ ] package.jsonにテストスクリプト追加
  ```json
  {
    "scripts": {
      "test": "vitest run",
      "test:watch": "vitest",
      "test:coverage": "vitest run --coverage"
    }
  }
  ```

#### 1-2. 最小限のテスト作成
- [ ] 純粋関数のテスト（`transformTitle`）
- [ ] 認証チェックのテスト（`checkAuthTokenEmail`）
- [ ] リクエストパラメータ構築のテスト

```typescript
// 例: 最初に作るシンプルなテスト
describe('transformTitle', () => {
  it('基本的な動作を確認', () => {
    expect(transformTitle('日報', '会議')).toBe('会議');
  });
});
```

#### 1-3. CI/CDパイプライン構築
- [ ] GitHub Actionsにテスト実行ステップ追加
- [ ] プッシュ時の自動テスト実行
- [ ] テスト失敗時のビルド停止

```yaml
# .github/workflows/check_firebase_cloud_function.yaml に追加
- run: npm --prefix functions run test
```

**完了条件**:
- [ ] 既存機能の基本的なテストが書かれている
- [ ] GitHub Actionsでテストが自動実行される
- [ ] テストが失敗したらマージできない

**所要時間**: 1-2日
- 環境構築とシンプルなテスト作成に集中
- CI/CD設定は既存の設定を拡張するだけ

---

### ステップ2: 既存コードのリファクタリング

**目標**: テストカバレッジの向上

#### 2-1. テストカバレッジの向上
- [ ] 各条件分岐のテスト追加
- [ ] エラーケースのテスト追加

#### 2-2. 型安全性の向上
- [ ] 入力・出力の型定義を厳密化
- [ ] ESA APIレスポンスの型定義

**完了条件**:
- [ ] モックを使ったテストが簡単に書ける
- [ ] カバレッジレポートが確認できる
- [ ] 既存機能が壊れていない（テストで保証）

**所要時間**: 2-3日
- リファクタリングは慎重に進める
- テストで動作を保証しながら実施

---

### ステップ3: 検索機能の一般化

**目標**: 柔軟な検索オプションを提供

#### 3-1. 検索オプション関数の実装
- [ ] `searchOptions.ts`の作成
- [ ] 各種オプション関数（`withCategory`, `withTags`等）
- [ ] ユニットテストの作成

```typescript
// 検索オプションの例
export const withCategory = (category: string) =>
  (config: SearchConfig) => {
    config.categoryQuery = `category:${category}`;
  };
```

#### 3-2. 汎用検索関数の実装
- [ ] `searchPosts`関数の実装
- [ ] 既存の`getDailyReport`を新実装で置き換え
- [ ] 回帰テストで動作確認

#### 3-3. 新規エンドポイントの追加
- [ ] `recentReports` Function（過去の日報リスト取得）
- [ ] 統合テストの追加

**完了条件**:
- [ ] 過去の日報が取得できる
- [ ] 既存のAPIは互換性を保っている

**所要時間**: 3-4日
- 新機能の実装とテスト
- フロントエンドとの結合確認

## 成功指標

### ステップ1完了時
- [ ] `npm run test`でテストが実行される
- [ ] GitHub Actionsでグリーンになる
- [ ] 最低限のテストケースが存在する

### ステップ2完了時
- [ ] モックを使ったテストが書きやすい
- [ ] 既存機能に影響なし
- [ ] 主要な条件分岐がテストされている

### ステップ3完了時
- [ ] 過去の日報閲覧機能が動作する
- [ ] ドキュメントが整備されている

## 注意事項

- 各ステップは独立してマージ可能
- ステップ1が完了してからステップ2に進む
- 既存機能を壊さないことを最優先
- テストファーストで進める
