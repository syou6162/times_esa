# フォーカス・カーソル位置維持対応チェックリスト

## 背景

ReactベースのWebアプリケーション（日報投稿システム）において、本文テキストフィールドでユーザーが文字入力中にバックエンドへのfetch（データ再取得やリロード）が発生すると、フォームや兄弟要素の再レンダリング・状態更新により入力欄のフォーカスが外れ、さらにカーソル（キャレット）位置もfetch前からズレてしまう問題が発生している。現状、値の維持はできているがフォーカス・カーソル位置維持の実装とテストが不足している。

## チェックリスト

### 実装部分

- [ ] **テキストフィールドへのref付与**
  - [ ] `useRef`フックを用いてテキストフィールドのDOM参照を取得
  - [ ] Material-UIの`TextField`に`inputRef`を設定

- [ ] **カーソル位置保持機能の実装**
  - [ ] カーソル位置記録用の`useRef`を追加（`caretRef`）
  - [ ] `onSelect`, `onKeyUp`, `onClick`イベントでカーソル位置を記録する関数を実装
  - [ ] `selectionStart`/`selectionEnd`をrefに保存する仕組みを作成

- [ ] **フォーカス・カーソル位置復元機能の実装**
  - [ ] `useEffect`で`fetching`と`sending`状態の変化を監視
  - [ ] 両方がfalseになった時点で`textInputRef.current?.focus()`を実行
  - [ ] `focus()`直後に`setSelectionRange`でカーソル位置を復元

- [ ] **key属性の安定化**
  - [ ] フォームやテキストフィールドの`key`属性が動的に変わらないよう確認
  - [ ] 不要なマウント・アンマウントを防ぐ

### テスト部分

- [ ] **E2E/ユニットテスト環境の準備**
  - [ ] React Testing LibraryまたはCypressのセットアップ確認
  - [ ] テストファイルの作成（`EsaTextField`または関連コンポーネント用）

- [ ] **フォーカス維持テストの実装**
  - [ ] テキストフィールドに文字列入力のテストケース作成
  - [ ] fetch処理発生をトリガーするテストケース作成
  - [ ] `document.activeElement`がテキストフィールドであることを検証

- [ ] **カーソル位置維持テストの実装**
  - [ ] 特定位置にカーソルを移動するテストケース作成
  - [ ] fetch前の`selectionStart`/`selectionEnd`を記録
  - [ ] fetch完了後に同じ位置が維持されていることを検証

- [ ] **複合的なユーザーシナリオテスト**
  - [ ] 入力中→fetch発生→入力継続のフローをテスト
  - [ ] タイトル・タグ欄が`disabled`になる間の動作テスト
  - [ ] 連続的なfetch発生時の動作テスト

### 検証・デバッグ部分

- [ ] **手動テストでの動作確認**
  - [ ] 実際の日報投稿画面でfetch発生時の動作確認
  - [ ] 様々なカーソル位置（文頭、文中、文末）での動作確認
  - [ ] 長文入力時の動作確認

- [ ] **エッジケース対応の確認**
  - [ ] fetch中にユーザーがカーソルを移動した場合の動作
  - [ ] 複数のテキストフィールドがある場合の影響確認
  - [ ] ブラウザ間での動作差異の確認

- [ ] **パフォーマンス影響の検証**
  - [ ] カーソル位置記録処理の頻度とパフォーマンス影響確認
  - [ ] メモリリーク等の問題がないことを確認

### 文書化部分

- [ ] **実装内容のドキュメント化**
  - [ ] 修正内容をREADMEまたは技術文書に記載
  - [ ] 使用した手法の説明を追加

- [ ] **テストケースの文書化**
  - [ ] 実装したテストの内容と目的を文書化
  - [ ] 将来の保守者向けの注意事項を記載
